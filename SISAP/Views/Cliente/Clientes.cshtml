<!--Modal  registro de usuario-->



<div id="modal_aside_right" class="modal fixed-right fade fuente " tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-aside " role="document">
        <div id="form" class="modal-content">
            <div class="modal-body mt-4 ">
                <div class="col-md-12 mx-auto">

                    <div class="card">
                        <div class="card-header p-1">
                            <h5>Perfil del cliente</h5>
                        </div>
                        <div class="card-body">

                            <div class="row">
                                <div class="col-sm-3 mb-3">
                                    <label>Codigo </label>
                                    <input type="number" id="ctxtCodigo" class="form-control" onkeypress="return ValidaLongitud(this, 7);" placeholder="" required />
                                    <span id="msjcodigo"></span>

                                </div>
                                <div hidden class="col-sm-3 mb-3">
                                    <label>ClienteId</label>
                                    <input type="text" id="ctxtClienteId" class="form-control" placeholder="" required />
                                </div>
                                <div hidden class="col-sm-3 mb-3">
                                    <label>EstadoServicioId</label>
                                    <input type="text" id="ctxtEstadoServicioId" class="form-control" placeholder="" />
                                </div>
                                <div class="col-sm-3 mb-3">
                                    <label>Nombre </label>
                                    <input type="text" id="ctxtNombre" class="form-control" placeholder="">
                                    <span id="msjnombre"></span>
                                </div>
                                <div class="col-sm-3 mb-3">
                                    <label>Apellido </label>
                                    <input type="text" id="ctxtApellido" class="form-control" placeholder="">
                                    <span id="msjapellido"></span>
                                </div>
                                <div class="col-sm-3 mb-3">
                                    <label>DNI </label>
                                    <input type="number" id="ctxtDNI" class="form-control" onkeypress="return ValidaLongitud(this, 8);" placeholder="">
                                </div>

                            </div>
                            <div class="row">

                                <div class="col-sm-3 mb-3">
                                    <label>Telefono </label>
                                    <input type="number" id="ctxtTelefono" class="form-control" onkeypress="return ValidaLongitud(this, 9);" placeholder="">

                                </div>

                            </div>

                        </div>
                    </div>
                    <br />
                    <div class="card">
                        <div class="card-header p-1" id="headerx">
                            <h5>Direccion  </h5>
                        </div>
                        <div class="card-body">

                            <div class="row">
                                <div class="col-sm-3 mb-3">
                                    <label>Urbanizacion</label>
                                    <select id="ddUrbanizacion" class="form-control">
                                    </select>
                                </div>
                                <div class="col-sm-3 mb-3">
                                    <label>Manzana</label>
                                    <select id="ddManzana" class="form-control">
                                    </select>
                                </div>

                                <div class="col-sm-3 mb-3">
                                    <label>Lote </label>
                                    <input type="number" id="ctxtDireccion" class="form-control" placeholder="05">


                                </div>
                                <div class="col-sm-3 mb-3">
                                    <label>Complemento</label>
                                    <input type="text" id="ctxtComplemento" class="form-control" placeholder="">
                                </div>

                            </div>
                        </div>
                    </div>
                    <br>
                    <div class="card">
                        <div class="card-header p-1" id="headerx">
                            <h5>Datos del servicio  </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-sm-3 mb-3">
                                    <label>Servicio</label>
                                    <select id="ddServicios" class="form-control">
                                    </select>
                                </div>
                                <div class="col-sm-3 mb-3">
                                    <label>Categoria</label>
                                    <select id="ddCategoria" class="form-control">
                                    </select>
                                </div>
                                <div class="col-sm-3 mb-3">
                                    <label>Estado</label>
                                    <select id="ddEstadoServicio" class="form-control">
                                    </select>
                                </div>
                                <div class="col-sm-3 mb-3">
                                    <label>Numero de medidor </label>
                                    <input required id="ctxtNumeroMedidor" type="text" class="form-control" onkeypress="return ValidaLongitud(this, 11);" placeholder="">
                                </div>

                                <div class="col-sm-3 mb-3">
                                    <label>Observaciones</label>
                                    <textarea class="form-control" id="ctxtObservaciones" rows="3"></textarea>
                                </div>
                            </div>


                        </div>
                    </div>

                </div>

            </div>

            <div class="modal-footer p-1">
                <label id="MSGvalidacion" class=" text-danger" style="display:none">Debe llenar todos los campos</label>
                <button type="button" class="btn btn-danger btn-sm" data-dismiss="modal">Cerrar</button>
                <button style="display:none;" class="btn btn-success btn-sm" id="btnSave" data-dismiss="modal" type="submit"><i class="fas fa-save"></i> Guardar</button>
                <button style="display:none;" class="btn btn-warning btn-sm" id="btnUpdate" data-dismiss="modal" type="submit"><i class="fas fa-save"></i> Actualizar</button>
            </div>
        </div>
    </div>
</div>


<!-- modal registrar cliente.// -->

<div class="card border-0 ml-4 mt-4 margin-l mb-3 ">
    <div class="card-body fuente">
        <div class=" card-header bg-dark text-white">
            <h5><i class="fas fa-table"> Clientes</i></h5>
        </div>

        <hr style="border-style: dashed;" />
        <div class="row">
            <div class="col-6">
                <div class="d-flex justify-content-start mb-2">
                    <button id="openModal" type="button" data-toggle="modal" data-target="#modal_aside_right" class="btn btn-info btn-sm" onclick="Edit(0)"><i class="fas fa-plus"></i> Registrar</button>
                </div>
            </div>
            <div class="col-6">
                <div class="d-flex justify-content-end mb-2">
                    <div class="searchbar">
                        <input class="search_input" type="text" id="txtFilter" name="" placeholder="Buscar...">
                        <a href="#" class="search_icon"><i class="fas fa-search"></i></a>
                    </div>
                </div>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-sm  table-striped table-responsive-sm" id="allGrilla">
                <thead>
                    <tr class="bg-info text-light">
                        <th scope="col">Codigo</th>
                        <th scope="col">Nombre</th>
                        <th scope="col">Direccion</th>
                        <th scope="col">Medidor</th>
                        <th scope="col">Estado</th>
                        <th scope="col">Opciones</th>
                    </tr>
                </thead>
            </table>
        </div>
        <div class="modal-footer p-1">
            <button class="btn btn-success btn-sm" id="btnExportar" type="submit"><i class="fas fa-file-excel"></i> Excel</button>
            <button class="btn btn-dark btn-sm" id="printPDF" onclick="window.print()" type="submit"><i class="fas fa-print"></i> Print</button>
        </div>

    </div>
</div>


<script>

    var tabla;

    var UsuarioCreacion = "@Session["usuario"]";

    $(document).ready(function () {

        $("#openModal").on('click', function () {

            $("#MSGvalidacion").hide();
            $("#btnSave").show();
            $("#btnUpdate").hide();
            Clean();
        })



        $("#ddUrbanizacion").change(function () {
            var id = $(this).val();
            ListarManzana(id);
        });

        ListUrbanizacion();

        ListarServicio();

        ListarCategoria();

        ListarEstadoServicio();

        $("#btnSave").click(Save);
        $("#btnUpdate").click(Update);

        tabla = $('#allGrilla').DataTable({
            "dom": 'Bfrtip',
            "lengthMenu": [[10, 30, 50, -1], [10, 30, 50, "All"]],
            "searching": false,
            "language": {
                "url": "https://cdn.datatables.net/plug-ins/1.10.24/i18n/Spanish.json"
            },
            "drawCallback": function () {
                $('.page-link').addClass('btn-sm  border-0')
            },

            "serverSide": true,
            "processing": true,
            "orderable": false,
            "ajax": {
                "url": '@Url.Content("~/Cliente/ListarClientes")',
                "type": 'POST',
                "data": function (d) {
                    return $.extend({}, d, {
                        FilterNombre: $("#txtFilter").val() == "" ? null : $("#txtFilter").val(),
                    });
                },
                "dataSrc": "data",
                "responsivePriority": 1,
                //"pageLength": 10
            },

            "columns": [
                { "data":"CodigoCliente"},
                { "data":"NombreCompleto" },
                { "data":"DireccionStr" },
                { "data":"NumeroMedidor" },
                { "data":"EstadoServicio.EstadoDescripcion" },
                {
                    "data": "id",  "render": function(data, type, row, meta) {
                        return "<i class='text-warning far fa-edit mr-3' onClick='Edit(" + JSON.stringify(row) + ")'></i> </a>" +
                            "<i class='text-danger fas fa-trash-alt mr-3' onClick='Delete(" + JSON.stringify(row) +")'></i>"
                            //"<i class='text-warning fas fa-lightbulb ' onClick='StatusUpdate(" + JSON.stringify(row) + ")'></i>"
                    }
                },
            ]
        });

        tabla.draw();

        $("#txtFilter").bind("keyup change", function () {
            tabla.draw();
        })

    });

    function ListarCategoria() {

        var comboCategoria = $("#ddCategoria");

        $.ajax({
            type: "POST",
            dataType: "json",
            url: '@Url.Content("~/Common/ListarCategoria")',
            success: function (dataObject) {
                var data = dataObject;
                if (data != null) {
                    comboCategoria.html('');
                    comboCategoria.append($("<option />").val("").text("--Seleccione--"));
                    $.each(data, function () {
                        comboCategoria.append($("<option />").val(this.CategoriaId).text(this.TipoCategoria));
                    })
                }
            }
        });
    }

    function ListarServicio() {
        var comboUrbanizacion = $("#ddServicios");
        $.ajax({
            type: "POST",
            dataType: "json",
            url: '@Url.Content("~/Common/ListarServicios")',
            success: function (dataObject) {
                var data = dataObject;
                if (data != null) {
                    comboUrbanizacion.html('');
                    comboUrbanizacion.append($("<option />").val("").text('--Seleccione--'));

                    $.each(data, function () {
                        comboUrbanizacion.append($("<option />").val(this.ServicioId).text(this.ServicioNombre));
                    })
                }
            }
        });
    }

    function ListUrbanizacion() {
        var comboUrbanizacion = $("#ddUrbanizacion");
        $.ajax({
            type: "POST",
            dataType: "json",
            url: '@Url.Content("~/Common/ListarUrbanizacion")',
            async: false,
            success: function (dataObject) {
                var data = dataObject;
                if (data != null) {
                    comboUrbanizacion.html('');
                    comboUrbanizacion.append($("<option />").val("").text('--Seleccione--'));

                    $.each(data, function () {
                        comboUrbanizacion.append($("<option />").val(this.UrbanizacionId).text(this.NombreUrbanizacion));
                    })
                }
            }
        });
    }

    function ListarManzana(id) {

        var comboManzana = $("#ddManzana");
        $.ajax({
            type: "POST",
            dataType: "json",
            url: '@Url.Content("~/Common/ListarManzana")',
            data: {UrbanizacionId: id},
            async: false,
            success: function (dataObject) {
                var data = dataObject;
                if (data != null) {
                    comboManzana.html('');
                    $.each(data, function () {
                        comboManzana.append($("<option />").val(this.ManzanaId).text(this.NombreManzana));
                    })
                }
            }
        });
    }

    function Edit(dCliente) {

        $("#MSGvalidacion").hide();
        $("#btnSave").hide();
        $("#btnUpdate").show();
        $("#modal_aside_right").modal('show');

        $("#ctxtClienteId").val(dCliente.ClienteId);
        $("#ctxtEstadoServicioId").val(dCliente.EstadoServicio.EstadoServicioId);

        $("#ctxtCodigo").val(dCliente.CodigoCliente);
        $("#ctxtNombre").val(dCliente.Nombre);
        $("#ctxtApellido").val(dCliente.Apellido);
        $("#ctxtDNI").val(dCliente.DNI);
        $("#ctxtTelefono").val(dCliente.Telefono);
        $("#ctxtDireccion").val(dCliente.Direccion);
        $("#ddUrbanizacion").val(dCliente.UrbanizacionId);
        $("#ctxtComplemento").val(dCliente.Complemento);
        ListarManzana(dCliente.UrbanizacionId);
        $("#ddServicios").val(dCliente.ServicioId);
        $("#ddCategoria").val(dCliente.CategoriaId);
        $("#ddEstadoServicio").val(dCliente.EstadoServicioId);
        $("#ddEstadoServicio").val(dCliente.EstadoServicioId);
        $("#ctxtNumeroMedidor").val(dCliente.NumeroMedidor);
        $("#ctxtObservaciones").val(dCliente.Observaciones);
        $("#ddEstadoServicio").val(dCliente.EstadoServicioId);

    }

    function Save() {

        if ($('#ctxtCodigo').val() == "" || $('#ctxtNombre').val() == "" || $('#ctxtApellido').val() == "" ||
            $('#ctxtDNI').val() == ""|| $('#ctxtTelefono').val() == "" || $('#ctxtDireccion').val() == "" ||
            $('#ddUrbanizacion').val() == "" || $('#ctxtComplemento').val() =="" || $('#ddServicios').val() == "" || $('#ddCategoria').val() == "" ||
            $('#ctxtNumeroMedidor').val() == "" || $('#ctxtObservaciones').val() =="") {
            $("#MSGvalidacion").show();

            return false;
        }

        var objCliente = {};
        objCliente.CodigoCliente = $("#ctxtCodigo").val();
        objCliente.UsuarioCreacion = UsuarioCreacion;
        objCliente.Nombre = $("#ctxtNombre").val();
        objCliente.Apellido = $("#ctxtApellido").val();
        objCliente.DNI = $("#ctxtDNI").val();
        objCliente.Telefono = $("#ctxtTelefono").val();
        objCliente.Direccion = $("#ctxtDireccion").val();
        objCliente.UrbanizacionId = $("#ddUrbanizacion").val();
        objCliente.ManzanaId = $("#ddManzana").val();
        objCliente.Complemento = $('#ctxtComplemento').val();
        objCliente.ServicioId = $("#ddServicios").val();
        objCliente.CategoriaId = $("#ddCategoria").val();
        objCliente.NumeroMedidor = $("#ctxtNumeroMedidor").val();
        objCliente.EstadoServicioId = $("#ddEstadoServicio").val();
        objCliente.Observaciones = $('#ctxtObservaciones').val();

        Swal.fire({
            position: 'top-end',
            icon: 'success',
            title: 'Tu trabajo ha sido guardado',
            showConfirmButton: false,
            timer: 1500
        })

        $.ajax({

            type: "POST",
            url: '@Url.Content("~/Cliente/RegistrarCliente")',
            data: JSON.stringify({
                objCliente: objCliente
            }),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (resp) {
                tabla.draw();
            }
        });
        Clean();

    }

    function Update() {
        var objCliente = {};

        objCliente.ClienteId = $("#ctxtClienteId").val();
        objCliente.UsuarioCreacion = UsuarioCreacion;
        objCliente.CodigoCliente = $("#ctxtCodigo").val();
        objCliente.Nombre = $("#ctxtNombre").val();
        objCliente.Apellido = $("#ctxtApellido").val();
        objCliente.DNI = $("#ctxtDNI").val();
        objCliente.Telefono = $("#ctxtTelefono").val();
        objCliente.Direccion = $("#ctxtDireccion").val();
        objCliente.UrbanizacionId = $("#ddUrbanizacion").val();
        objCliente.ManzanaId = $("#ddManzana").val();
        objCliente.Complemento = $("#ctxtComplemento").val();
        objCliente.ServicioId = $("#ddServicios").val();
        objCliente.CategoriaId = $("#ddCategoria").val();
        objCliente.NumeroMedidor = $("#ctxtNumeroMedidor").val();
        objCliente.Observaciones = $("#ctxtObservaciones").val();
        objCliente.EstadoServicioId = $("#ddEstadoServicio").val();

        Swal.fire({
            position: 'top-end',
            icon: 'success',
            title: 'Tu trabajo ha sido Actualizado',
            showConfirmButton: false,
            timer: 1500
        })

        $.ajax({

            type: "POST",
            contentType: "application/json; charset=utf-8",
            url: '@Url.Content("~/Cliente/Update")',
            dataType: "json",
            data: JSON.stringify({
                objCliente: objCliente
            }),
            success: function (resp) {
                tabla.draw();
            }
        });
        Clean();
    }

    @*function Delete(dCliente) {
        Swal.fire({
            title: '¿Estas Seguro?',
            text: "¡Se eliminará este registro!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonColor: 'Si, eliminar'
        }).then((result) => {
            if (result.isConfirmed) {
                var data = { ClienteId: dCliente.ClienteId };
        $.ajax({
            type: "POST",
            contentType: "application/json; charset=utf-8",
            url: '@Url.Content("~/Cliente/Delete")',
            dataType: "json",
            data: JSON.stringify(data),
            success: function () {
                tabla.draw();
                console.log("eliminado");
            }
        });
                Swal.fire(
                    'Eliminado!',
                    'Cliente Eliminado',
                    'success'
                )

            }
        })


    }*@


      const swalWithBootstrapButtons = Swal.mixin({
  customClass: {
    confirmButton: 'btn btn-success',
    cancelButton: 'btn btn-danger'
  },
  buttonsStyling: false
    })
    function Delete(dCliente) {
        swalWithBootstrapButtons.fire({
            title: 'Estas Seguro?',
            text: "No podrás revertir esto!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Si, Eliminar!',
            cancelButtonText: 'No, Cancelar!',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                var data = { ClienteId: dCliente.ClienteId };
        $.ajax({
            type: "POST",
            contentType: "application/json; charset=utf-8",
            url: '@Url.Content("~/Cliente/Delete")',
            dataType: "json",
            data: JSON.stringify(data),
            success: function () {
                tabla.draw();
                console.log("eliminado");
            }
        });
                swalWithBootstrapButtons.fire(
                    'Eliminado!',
                    'Cliente  a sido eliminado.',
                    'success'
                )
            } else if (
                /* Read more about handling dismissals below */
                result.dismiss === Swal.DismissReason.cancel
            ) {
                swalWithBootstrapButtons.fire(
                    'Cancelado',
                    'Tu archivo imaginario está seguro : )',
                    'error'
                )
            }
        })
    }

    function Clean() {
        $("#ctxtClienteId").val("");
        $("#ctxtEstadoServicioId").val("");
        $("#ctxtCodigo").val("");
        $("#ctxtNombre").val("");
        $("#ctxtApellido").val("");
        $("#ctxtDNI").val("");
        $("#ctxtTelefono").val("");
        $("#ctxtDireccion").val("");
        $("#ctxtComplemento").val("");
        $("#ddUrbanizacion").val("");
        $("#ddManzana").val("");
        $("ctxtComplemento").val("");
        $("#ddServicios").val("");
        $("#ddCategoria").val("");
        $("#ctxtObservaciones").val("");
        $("#ctxtNumeroMedidor").val("");
    }

    function ListarEstadoServicio() {
        var comboEstadoServicio = $("#ddEstadoServicio");
        $.ajax({
            type: "POST",
            url: '@Url.Content("~/Common/ListarEstadoServicio")',
            dataType: "json",
            async: false,
            success: function (resp) {
                var data = resp;
                if (data != null) {
                    comboEstadoServicio.html('');
                    comboEstadoServicio.append($("<option />").val("").text("--Seleccione--"));
                    $.each(data, function () {
                        comboEstadoServicio.append($("<option />").val(this.EstadoServicioId).text(this.EstadoDescripcion));
                    })
                }

            }
        });
    }

</script>
@*<script type="text/javascript" src="~/Scripts/registrocliente/registrocliente.js"></script>*@
<script>

    function asegurar() {
        rc = confirm("¿Seguro que desea Eliminar?");
        return rc;
    }

    function ValidaLongitud(campo, longitudMaxima) {
        try {
            if (campo.value.length > (longitudMaxima - 1))
                return false;
            else
                return true;
        } catch (e) {
            return false;
        }
    }
</script>